:setvar DLLPath "D:\VisualStudio\AWDW\Scripts\AWDWScripts\AWDWClr\obj\Debug\AWDWClr.dll"
:setvar DatabaseName "Temp"

USE master;

GO
IF NOT EXISTS
(
	SELECT * FROM sys.symmetric_keys WHERE symmetric_key_id = 101
)
BEGIN
	CREATE MASTER KEY ENCRYPTION BY PASSWORD = '123456';
END;

GO
IF EXISTS
(
	SELECT * FROM sys.database_principals WHERE name = 'AWDWClrUser'
)
BEGIN
	DROP user AWDWClrUser;
END;
IF EXISTS
(
	SELECT * FROM sys.server_principals WHERE name = 'AWDWClrLogin'
)
BEGIN
	DROP LOGIN AWDWClrLogin;
END;
IF EXISTS
(
	SELECT * FROM sys.asymmetric_keys WHERE name = 'AWDWClrKey'
)
BEGIN
	DROP ASYMMETRIC KEY [AWDWClrKey];
END;

go
open master key decryption by password = '123456'

go
CREATE ASYMMETRIC KEY AWDWClrKey 
	--FROM EXECUTABLE FILE = '$(DLLPath)';
	FROM FILE = 'D:\VisualStudio\AWDW\Scripts\AWDWScripts\AWDWClr\AWDWClrKey.snk'

GO
close master key

GO
CREATE LOGIN AWDWClrLogin FROM ASYMMETRIC KEY AWDWClrKey;

GO
GRANT UNSAFE ASSEMBLY TO AWDWClrLogin;



use master
alter database temp set single_user with rollback immediate
drop database temp
create database Temp
use temp

GO
CREATE ASSEMBLY [AWDWClr]
    AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030006D42C570000000000000000E00022200B013000000A000000060000000000008E2900000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000000000000300608500001000001000000000100000100000000000001000000000000000000000003C2900004F000000004000006803000000000000000000000000000000000000006000000C000000042800001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E746578740000009409000000200000000A000000020000000000000000000000000000200000602E72737263000000680300000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C000000006000000002000000100000000000000000000000000000400000420000000000000000000000000000000070290000000000004800000002000500BC200000480700000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133001001B000000010000110002281000000A0B1201281100000A0A06731200000A0C2B00082A00133002002C0000000200001100281300000A6F1400000A281500000A0A0206281600000A0C1202281100000A0B07731200000A0D2B00092A2202281700000A002A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000044020000237E0000B00200004003000023537472696E677300000000F00500000400000023555300F4050000100000002347554944000000040600004401000023426C6F620000000000000002000001471502000900000000FA013300160000010000001400000002000000030000000200000017000000100000000200000001000000020000000000510201000000000006007301DE020600E001DE0206009200AC020F00FE0200000600BA0064020600560164020600220164020600C70164020600930164020600AC0164020600D10064020600A600BF0206008400BF020600050164020600EC00FE01060037035D020A00410183020A0018020D0306007B005D02060076025D020000000001000000000001000100010010002203000041000100010050200000000096000A005400010078200000000096002B0254000200B020000000008618A60206000300000001004B020000010059000900A60201001100A60206001900A6020A002900A60210003100A60210003900A60210004100A60210004900A60210005100A60210005900A60210006100A60215006900A60210007100A60210007900A60210008900A6020600A100480022009900220229009100A6021000A10041023700A1005D002900A10064003C00A100350042008100A602060020007B003C012E000B005B002E00130064002E001B0083002E0023008C002E002B0099002E00330099002E003B0099002E0043008C002E004B009F002E00530099002E005B0099002E006300B7002E006B00E1002E007300EE0040007B003C011A002D000480000001000000000000000000000000009E0200000400000000000000000000004B002C00000000000400000000000000000000004B0020000000000000000000003C4D6F64756C653E0054696D655A6F6E65496E666F4C6F63616C325554430053797374656D2E44617461006D73636F726C696200436F6E7665727454696D6546726F6D55746300436F6E7665727454696D65546F55746300757463006765745F49640046696E6453797374656D54696D655A6F6E6542794964004461746554696D6500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E6700546F537472696E670054696D655A6F6E65496E666F555443324C6F63616C006765745F4C6F63616C006C6F63616C0041574457436C722E646C6C0053797374656D0053797374656D2E5265666C656374696F6E0054696D655A6F6E65496E666F004D6963726F736F66742E53716C5365727665722E5365727665720041574457436C72002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730055736572446566696E656446756E6374696F6E73004F626A656374000000000000002A8F93BF1014AB478588C8786D57E67400042001010803200001052001011111042001010E04200101020707030E114D1149060001114D114D0320000E09070412510E114D1149040000125105000112510E080002114D114D125108B77A5C561934E0890600011149114D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000000C01000741574457436C72000005010000000017010012436F7079726967687420C2A920203230313600002901002432363764313465372D343962342D343062652D613661302D39326166366637333033373800000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E352E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E352E3204010000000000000000000006D42C5700000000020000001C01000020280000200A000052534453CFE047A1CB8F9540B5EFFA50B7FBFA6401000000443A5C56697375616C53747564696F5C415744575C536372697074735C41574457536372697074735C41574457436C725C6F626A5C44656275675C41574457436C722E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006429000000000000000000007E29000000200000000000000000000000000000000000000000000070290000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000000C03000000000000000000000C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B0046C020000010053007400720069006E006700460069006C00650049006E0066006F0000004802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D0065000000000000000000380008000100460069006C0065004400650073006300720069007000740069006F006E0000000000410057004400570043006C0072000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000038000C00010049006E007400650072006E0061006C004E0061006D0065000000410057004400570043006C0072002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003100360000002A00010001004C006500670061006C00540072006100640065006D00610072006B007300000000000000000040000C0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000410057004400570043006C0072002E0064006C006C000000300008000100500072006F0064007500630074004E0061006D00650000000000410057004400570043006C0072000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000903900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    --WITH PERMISSION_SET = UNSAFE;


GO
PRINT N'Creating [dbo].[TimeZoneInfoLocal2UTC]...';


GO
CREATE FUNCTION [dbo].[TimeZoneInfoLocal2UTC]
(@local DATETIME)
RETURNS NVARCHAR (MAX)
AS
 EXTERNAL NAME [AWDWClr].[UserDefinedFunctions].[TimeZoneInfoLocal2UTC]


GO
PRINT N'Creating [dbo].[TimeZoneInfoUTC2Local]...';


GO
CREATE FUNCTION [dbo].[TimeZoneInfoUTC2Local]
(@utc DATETIME)
RETURNS NVARCHAR (MAX)
AS
 EXTERNAL NAME [AWDWClr].[UserDefinedFunctions].[TimeZoneInfoUTC2Local]

GO
use master;

GO
IF NOT EXISTS (SELECT * FROM sys.symmetric_keys WHERE symmetric_key_id = 101)
BEGIN
	CREATE MASTER KEY ENCRYPTION BY PASSWORD = '123456'
END

GO
if exists (select * from sys.database_principals where name = 'AWDWClrUser')
begin
	drop user AWDWClrUser
end
if exists (select * from sys.server_principals where name = 'AWDWClrLogin')
begin
	drop login [AWDWClrLogin]
end
if exists (select * from sys.asymmetric_keys where name = 'AWDWClrKey')
begin
	DROP ASYMMETRIC KEY [AWDWClrKey];
end

use Temp
CREATE ASYMMETRIC KEY AWDWClrKey
		from assembly AWDWClr
		--FROM FILE = 'D:\VisualStudio\SharedDLL\AWDWClrKey.snk'
CREATE ASYMMETRIC KEY AWDWClrKey
	from executable file = 'D:\VisualStudio\SharedDLL\AWDWClr.dll'
GO
CREATE LOGIN [AWDWClrLogin] FROM ASYMMETRIC KEY AWDWClrKey;

create assembly AWDWClr
from 'D:\VisualStudio\SharedDLL\AWDWClr.dll'
with permission_set = unsafe

go
create function [dbo].[TimeZoneInfoLocal2UTC](@local datetime)
returns nvarchar(max)
as
external name AWDWClr.UserDefinedFunctions.TimeZoneInfoLocal2UTC

go
drop assembly AWDWClr
drop function [dbo].[TimeZoneInfoLocal2UTC]
drop function [dbo].[TimeZoneInfoUTC2Local]
GO

GRANT UNSAFE ASSEMBLY TO AWDWClrLogin;
GO

use Temp;

select [dbo].[TimeZoneInfoLocal2UTC](getdate())
GO

alter

GO
/*
Post-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be appended to the build script.		
 Use SQLCMD syntax to include a file in the post-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the post-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/
GO

GO
DECLARE @VarDecimalSupported AS BIT;

SELECT @VarDecimalSupported = 0;

IF ((ServerProperty(N'EngineEdition') = 3)
    AND (((@@microsoftversion / power(2, 24) = 9)
          AND (@@microsoftversion & 0xffff >= 3024))
         OR ((@@microsoftversion / power(2, 24) = 10)
             AND (@@microsoftversion & 0xffff >= 1600))))
    SELECT @VarDecimalSupported = 1;

IF (@VarDecimalSupported > 0)
    BEGIN
        EXECUTE sp_db_vardecimal_storage_format N'$(DatabaseName)', 'ON';
    END


GO
PRINT N'Update complete.';


GO


use staging
select getdate(), getutcdate(), [dbo].[TimeZoneInfoLocal2UTC](getdate())

alter assembly [AWDWClr] with permission_set = unsafe

select * from sys.asymmetric_keys where name = 'AWDWClrKey'
select * from sys.assemblies

select suser_sname(), user_name()

CREATE ASYMMETRIC KEY [AWDWClrKey] FROM FILE = 'D:\VisualStudio\SharedDLL\AWDWClrKey.snk'

select * from sys.symmetric_keys

select * from sys.server_principals where name = 'AWDWClrLogin'

select * from sys.asymmetric_keys
